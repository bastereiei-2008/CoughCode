<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Boot theme ก่อนโหลด CSS -->
  <script>
    (function () {
      var t = localStorage.getItem('theme');
      if (!t) t = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', t);
    })();
  </script>

  <link rel="stylesheet" href="styles.css" />
  <title>อาการร่วม</title>
</head>
<body>
  <!-- header/nav เดิมของคุณอยู่ตรงนี้ได้ -->

  <main class="container">
    <form id="symptomForm" class="symptoms-card">
      <header class="symptoms-header">
        <h1 class="title">อาการร่วม</h1>
        <p class="subtitle">เลือกอาการที่พบร่วมกัน (เลือกได้หลายข้อ)</p>
        <p class="hint">เลือกอาการอย่างน้อย <b>1</b> ข้อ</p>
      </header>

      <!-- รายการอาการ: มือถือ 1 คอลัมน์ / จอกว้าง 2 คอลัมน์ -->
      <div class="symptoms-grid">
        <label class="symptom-item"><input type="checkbox" name="sym" value="คัดจมูก"><span>คัดจมูก</span></label>
        <label class="symptom-item"><input type="checkbox" name="sym" value="น้ำมูกไหล"><span>น้ำมูกไหล</span></label>

        <label class="symptom-item"><input type="checkbox" name="sym" value="เจ็บคอ"><span>เจ็บคอ</span></label>
        <label class="symptom-item"><input type="checkbox" name="sym" value="ไข้ต่ำ"><span>ไข้ต่ำ</span></label>

        <label class="symptom-item"><input type="checkbox" name="sym" value="ไข้สูง"><span>ไข้สูง</span></label>
        <label class="symptom-item"><input type="checkbox" name="sym" value="อ่อนเพลีย"><span>อ่อนเพลีย</span></label>

        <label class="symptom-item"><input type="checkbox" name="sym" value="ปวดศีรษะ"><span>ปวดศีรษะ</span></label>
        <label class="symptom-item"><input type="checkbox" name="sym" value="เจ็บหน้าอก"><span>เจ็บหน้าอก</span></label>

        <label class="symptom-item"><input type="checkbox" name="sym" value="หายใจลำบาก"><span>หายใจลำบาก</span></label>
        <label class="symptom-item"><input type="checkbox" name="sym" value="ปวดเมื่อยตามตัว"><span>ปวดเมื่อยตามตัว</span></label>

        <label class="symptom-item"><input type="checkbox" name="sym" value="หายใจเร็ว"><span>หายใจเร็ว</span></label>
        <label class="symptom-item"><input type="checkbox" name="sym" value="หายใจหอบเหนื่อย"><span>หายใจหอบเหนื่อย</span></label>

        <label class="symptom-item"><input type="checkbox" name="sym" value="เบื่ออาหาร"><span>เบื่ออาหาร</span></label>
        <label class="symptom-item"><input type="checkbox" name="sym" value="น้ำหนักลด"><span>น้ำหนักลด</span></label>

        <label class="symptom-item"><input type="checkbox" name="sym" value="เหงื่อออกตอนกลางคืน"><span>เหงื่อออกตอนกลางคืน</span></label>
      </div>

      <div class="actions">
        <button type="submit" class="btn-primary">เสร็จสิ้น</button>
      </div>
    </form>
  </main>

  <script src="theme.js" defer></script>

  <!-- สคริปต์ส่งข้อมูล (เวอร์ชันที่มี timeout + fallback ที่คุณใช้ได้แล้ว) -->
  <script>
  (() => {
    const API_URL   = "https://coughcode.onrender.com/predict";
    const TIMEOUT_MS = 12000;

    const form = document.getElementById('symptomForm');
    const btn  = form.querySelector('button[type="submit"]');
    const hint = form.querySelector('.hint');

    function updateBtn() {
      const any = form.querySelectorAll('input[name="sym"]:checked').length > 0;
      btn.disabled = !any;
      if (hint) hint.textContent = any ? '' : 'เลือกอาการอย่างน้อย 1 ข้อ';
    }
    form.addEventListener('change', updateBtn); updateBtn();

    function dataURLtoBlob(dataURL){
      const [head, b64] = dataURL.split(',');
      const mime = (head.match(/:(.*?);/)||[])[1] || 'application/octet-stream';
      const bin = atob(b64); const u8 = new Uint8Array(bin.length);
      for (let i=0;i<bin.length;i++) u8[i] = bin.charCodeAt(i);
      return new Blob([u8], { type: mime });
    }

    function getSymptoms(){
      return [...form.querySelectorAll('input[name="sym"]:checked')].map(el=>el.value);
    }

    function fallbackFromSymptoms(sym){
      let score = { "ไข้หวัด":0.40, "หลอดลมอักเสบ":0.35, "ปอดอักเสบ":0.25 };
      const has = k => sym.includes(k);
      if (has("คัดจมูก")) score["ไข้หวัด"] += 0.06;
      if (has("น้ำมูกไหล")) score["ไข้หวัด"] += 0.06;
      if (has("เจ็บคอ"))   score["ไข้หวัด"] += 0.05;
      if (has("ไข้ต่ำ"))   score["ไข้หวัด"] += 0.04;
      if (has("ไข้สูง")) { score["ปอดอักเสบ"] += 0.06; score["หลอดลมอักเสบ"] += 0.02; }
      if (has("อ่อนเพลีย")) score["ไข้หวัด"] += 0.02;
      if (has("ปวดเมื่อยตามตัว")) score["ไข้หวัด"] += 0.02;
      if (has("ปวดศีรษะ")) score["ไข้หวัด"] += 0.02;
      if (has("เจ็บหน้าอก")) score["ปอดอักเสบ"] += 0.06;
      if (has("หายใจลำบาก")) { score["ปอดอักเสบ"] += 0.08; score["หลอดลมอักเสบ"] += 0.03; }
      if (has("หายใจเร็ว")) score["ปอดอักเสบ"] += 0.05;
      if (has("หายใจหอบเหนื่อย")) { score["ปอดอักเสบ"] += 0.08; score["หลอดลมอักเสบ"] += 0.04; }
      if (has("เบื่ออาหาร")) score["ปอดอักเสบ"] += 0.02;
      if (has("น้ำหนักลด")) score["ปอดอักเสบ"] += 0.03;
      if (has("เหงื่อออกตอนกลางคืน")) score["ปอดอักเสบ"] += 0.03;
      const s = Object.values(score).reduce((a,b)=>a+b,0);
      Object.keys(score).forEach(k=>score[k]/=s);
      return score;
    }

    async function fetchWithTimeout(url, opt={}, timeoutMs=TIMEOUT_MS){
      const ctrl = new AbortController();
      const id = setTimeout(() => ctrl.abort('timeout'), timeoutMs);
      try { return await fetch(url, { ...opt, signal: ctrl.signal }); }
      finally { clearTimeout(id); }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const dataURL = sessionStorage.getItem('audioDataURL');
      if (!dataURL) { alert('ไม่พบไฟล์เสียง กรุณาอัดเสียงก่อน'); location.href='./record.html'; return; }
      const audioBlob = dataURLtoBlob(dataURL);

      const symptoms = getSymptoms();
      sessionStorage.setItem('symptoms', JSON.stringify(symptoms));

      btn.disabled = true; const old = btn.textContent; btn.textContent = 'กำลังส่งข้อมูล...';

      const fd = new FormData();
      fd.append('file', audioBlob, 'recording.webm');
      fd.append('symptoms', JSON.stringify(symptoms));

      try{
        const r = await fetchWithTimeout(API_URL, { method:'POST', body: fd });
        if (!r.ok) throw new Error('HTTP '+r.status);
        const json = await r.json();
        sessionStorage.setItem('diagnosis', JSON.stringify(json));
        sessionStorage.removeItem('diag_fallback');
        location.href = './result.html';
      }catch(err){
        const fb = { conditions: fallbackFromSymptoms(symptoms), note:'fallback' };
        sessionStorage.setItem('diagnosis', JSON.stringify(fb));
        sessionStorage.setItem('diag_fallback','1');
        sessionStorage.setItem('diag_error_msg', String(err && err.message || err));
        location.href = './result.html';
      }finally{
        btn.textContent = old;
      }
    });
  })();
  </script>
</body>
</html>
      color:#e9f1ff;
    }

    .title{
      text-align:center;
      font-size:28px;
      font-weight:800;
      letter-spacing:.2px;
      margin:6px 0 6px;
    }
    .subtitle{
      text-align:center;
      opacity:.7;
      margin-bottom:18px;
    }

    /* กริด 2 คอลัมน์ */
    .grid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:14px 18px;
      margin-top:8px;
    }
    @media (max-width: 680px){
      .grid{ grid-template-columns: 1fr; }
    }

    /* แถวอาการ */
    .sym-item{
      display:flex; align-items:center; gap:12px;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);
      border-radius:14px; padding:16px 18px;
    }

    /* สไตล์เช็กบ็อกซ์สี่เหลี่ยม */
    .sym-item input[type="checkbox"]{
      appearance:none; -webkit-appearance:none;
      width:20px; height:20px; border-radius:6px;
      border:2px solid rgba(255,255,255,.35);
      display:grid; place-items:center; cursor:pointer;
      background: transparent; transition: all .15s ease;
    }
    .sym-item input[type="checkbox"]::before{
      content:""; width:12px; height:12px; border-radius:3px;
      transform:scale(0); transition: transform .12s ease;
      background:#60a5fa;  /* ฟ้า */
      box-shadow: 0 0 0 2px rgba(96,165,250,.35) inset;
    }
    .sym-item input[type="checkbox"]:checked{
      border-color:#60a5fa; background:rgba(96,165,250,.1);
    }
    .sym-item input[type="checkbox"]:checked::before{ transform:scale(1); }

    .actions{ display:flex; justify-content:center; margin-top:20px; }
    .btn{
      min-width:160px;
      padding:12px 18px; border-radius:14px; cursor:pointer;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg,#3b82f6,#2563eb);
      color:#fff; font-weight:700; letter-spacing:.2px;
      box-shadow: 0 8px 26px rgba(37,99,235,.35);
      transition: transform .08s ease, filter .2s ease, opacity .2s ease;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn[disabled]{ opacity:.55; pointer-events:none; filter:grayscale(.2); }

    .warn{ text-align:center; color:#ffb4b4; margin-top:10px; min-height:22px; }
  </style>
</head>
<body>
  <main class="container">
 <form id="symptomForm" class="symptoms-card">
  <header class="symptoms-header">
    <h1 class="title">อาการร่วม</h1>
    <p class="subtitle">เลือกอาการที่พบร่วมกัน (เลือกได้หลายข้อ)</p>
    <p class="hint">เลือกอาการอย่างน้อย <b>1</b> ข้อ</p>
  </header>
    
  
    <div class="symptoms-grid">
      <label class="symptom-item"><input type="checkbox" name="sym" value="คัดจมูก"><span>คัดจมูก</span></label>
      <label class="symptom-item"><input type="checkbox" name="sym" value="น้ำมูกไหล"><span>น้ำมูกไหล</span></label>
      <label class="symptom-item"><input type="checkbox" name="sym" value="เจ็บคอ"><span>เจ็บคอ</span></label>
      <label class="symptom-item"><input type="checkbox" name="sym" value="ไข้ต่ำ"><span>ไข้ต่ำ</span></label>
      <label class="symptom-item"><input type="checkbox" name="sym" value="ไข้สูง"><span>ไข้สูง</span></label>
      <label class="symptom-item"><input type="checkbox" name="sym" value="อ่อนเพลีย"><span>อ่อนเพลีย</span></label>
      <label class="symptom-item"><input type="checkbox" name="sym" value="ปวดศีรษะ"><span>ปวดศีรษะ</span></label>
      <label class="symptom-item"><input type="checkbox" name="sym" value="เจ็บหน้าอก"><span>เจ็บหน้าอก</span></label>
      <label class="symptom-item"><input type="checkbox" name="sym" value="หายใจลำบาก"><span>หายใจลำบาก</span></label>
      <label class="symptom-item"><input type="checkbox" name="sym" value="ปวดเมื่อยตามตัว"><span>ปวดเมื่อยตามตัว</span></label>
      <label class="symptom-item"><input type="checkbox" name="sym" value="หายใจเร็ว"><span>หายใจเร็ว</span></label>
      <label class="symptom-item"><input type="checkbox" name="sym" value="หายใจหอบเหนื่อย"><span>หายใจหอบเหนื่อย</span></label>
      <label class="symptom-item"><input type="checkbox" name="sym" value="เบื่ออาหาร"><span>เบื่ออาหาร</span></label>
      <label class="symptom-item"><input type="checkbox" name="sym" value="น้ำหนักลด"><span>น้ำหนักลด</span></label>
      <label class="symptom-item"><input type="checkbox" name="sym" value="เหงื่อออกตอนกลางคืน"><span>เหงื่อออกตอนกลางคืน</span></label>
    </div>
    <div class="actions">
      <button type="submit" class="btn-primary">เสร็จสิ้น</button>
    </div>
  </form>
</main>

<script>
(() => {
  const API_URL   = "https://coughcode.onrender.com/predict"; // ใส่ของคุณ
  const TIMEOUT_MS = 12000;  // 12 วินาทีพอ—ช้ากว่านี้ให้ fallback

  const form = document.getElementById('symptomForm');
  const btn  = form.querySelector('button[type="submit"]');
  const hint = form.querySelector('.hint');

  function updateBtn() {
    const any = form.querySelectorAll('input[name="sym"]:checked').length > 0;
    btn.disabled = !any;
    if (hint) hint.textContent = any ? '' : 'เลือกอาการอย่างน้อย 1 ข้อ';
  }
  form.addEventListener('change', updateBtn); updateBtn();

  function dataURLtoBlob(dataURL){
    const [head, b64] = dataURL.split(',');
    const mime = (head.match(/:(.*?);/)||[])[1] || 'application/octet-stream';
    const bin = atob(b64); const u8 = new Uint8Array(bin.length);
    for (let i=0;i<bin.length;i++) u8[i] = bin.charCodeAt(i);
    return new Blob([u8], { type: mime });
  }

  // ดึงชื่ออาการที่ติ๊กไว้
  function getSymptoms(){
    return [...form.querySelectorAll('input[name="sym"]:checked')].map(el=>el.value);
  }

  // fallback ถ้า API ไม่ตอบ/ล่ม
  function fallbackFromSymptoms(sym){
    let score = { "ไข้หวัด":0.40, "หลอดลมอักเสบ":0.35, "ปอดอักเสบ":0.25 };
    const has = k => sym.includes(k);
    if (has("คัดจมูก")) score["ไข้หวัด"] += 0.06;
    if (has("น้ำมูกไหล")) score["ไข้หวัด"] += 0.06;
    if (has("เจ็บคอ"))   score["ไข้หวัด"] += 0.05;
    if (has("ไข้ต่ำ"))   score["ไข้หวัด"] += 0.04;
    if (has("ไข้สูง")) { score["ปอดอักเสบ"] += 0.06; score["หลอดลมอักเสบ"] += 0.02; }
    if (has("อ่อนเพลีย")) score["ไข้หวัด"] += 0.02;
    if (has("ปวดเมื่อยตามตัว")) score["ไข้หวัด"] += 0.02;
    if (has("ปวดศีรษะ")) score["ไข้หวัด"] += 0.02;
    if (has("เจ็บหน้าอก")) score["ปอดอักเสบ"] += 0.06;
    if (has("หายใจลำบาก")) { score["ปอดอักเสบ"] += 0.08; score["หลอดลมอักเสบ"] += 0.03; }
    if (has("หายใจเร็ว")) score["ปอดอักเสบ"] += 0.05;
    if (has("หายใจหอบเหนื่อย")) { score["ปอดอักเสบ"] += 0.08; score["หลอดลมอักเสบ"] += 0.04; }
    if (has("เบื่ออาหาร")) score["ปอดอักเสบ"] += 0.02;
    if (has("น้ำหนักลด")) score["ปอดอักเสบ"] += 0.03;
    if (has("เหงื่อออกตอนกลางคืน")) score["ปอดอักเสบ"] += 0.03;
    const s = Object.values(score).reduce((a,b)=>a+b,0);
    Object.keys(score).forEach(k=>score[k]/=s);
    return score;
  }

  // fetch พร้อม timeout
  async function fetchWithTimeout(url, opt={}, timeoutMs=TIMEOUT_MS){
    const ctrl = new AbortController();
    const id = setTimeout(() => ctrl.abort('timeout'), timeoutMs);
    try {
      const res = await fetch(url, { ...opt, signal: ctrl.signal });
      return res;
    } finally {
      clearTimeout(id);
    }
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const dataURL = sessionStorage.getItem('audioDataURL');
    if (!dataURL) { alert('ไม่พบไฟล์เสียง กรุณาอัดเสียงก่อน'); location.href='./record.html'; return; }

    // เตรียมข้อมูล
    const audioBlob = dataURLtoBlob(dataURL);
    const symptoms = getSymptoms();
    sessionStorage.setItem('symptoms', JSON.stringify(symptoms));

    // guard: ไฟล์ใหญ่เกินไป (เช่น > 8MB) ให้เตือนและลดเวลารอ
    if (audioBlob.size > 8 * 1024 * 1024) {
      alert('ไฟล์เสียงใหญ่เกินไป แนะนำอัด 3–5 วินาที');
    }

    // UI state
    btn.disabled = true;
    const oldText = btn.textContent;
    btn.textContent = 'กำลังส่งข้อมูล...';

    // ส่งไป API (multipart)
    const fd = new FormData();
    fd.append('file', audioBlob, 'recording.webm');
    fd.append('symptoms', JSON.stringify(symptoms));

    try{
      const r = await fetchWithTimeout(API_URL, { method:'POST', body: fd });
      if (!r.ok) throw new Error('HTTP '+r.status);
      const json = await r.json();
      sessionStorage.setItem('diagnosis', JSON.stringify(json));
      sessionStorage.removeItem('diag_fallback');
      location.href = './result.html';
    } catch (err) {
      // สาเหตุพบบ่อย: timeout, CORS, URL ผิด, เซิร์ฟเวอร์ค้าง/หนาวจัด (cold start)
      console.warn('predict failed:', err);

      const fb = { conditions: fallbackFromSymptoms(symptoms), note: 'fallback' };
      sessionStorage.setItem('diagnosis', JSON.stringify(fb));
      sessionStorage.setItem('diag_fallback','1');

      // แจ้งเหตุผล แล้วพาไปผลลัพธ์
      sessionStorage.setItem('diag_error_msg', String(err && err.message || err));
      location.href = './result.html';
    } finally {
      btn.textContent = oldText;
    }
  });
})();
</script>
</body>
</html>

</body>
</html>
