  <!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>อาการร่วม</title>

  <link rel="stylesheet" href="styles.css" />
  <script src="theme.js" defer></script>

  <style>
    /* ฉากหลังไล่เฉดฟ้า-น้ำเงินแบบนุ่มตา */
    body{
      min-height:100dvh;
      background: radial-gradient(1200px 600px at 50% -200px,#0b223d 0%,#081423 50%,#07111d 100%) fixed;
      display:flex;align-items:center;justify-content:center;
      padding:24px;
    }

    /* กล่องการ์ดกลาง */
    .card{
      width:min(980px, 96vw);
      background: rgba(9,16,30,.92);
      border:1px solid rgba(255,255,255,.06);
      border-radius:22px;
      box-shadow: 0 30px 80px rgba(0,0,0,.45), 0 8px 30px rgba(0,0,0,.3);
      padding:28px 26px 26px;
      color:#e9f1ff;
    }

    .title{
      text-align:center;
      font-size:28px;
      font-weight:800;
      letter-spacing:.2px;
      margin:6px 0 6px;
    }
    .subtitle{
      text-align:center;
      opacity:.7;
      margin-bottom:18px;
    }

    /* กริด 2 คอลัมน์ */
    .grid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:14px 18px;
      margin-top:8px;
    }
    @media (max-width: 680px){
      .grid{ grid-template-columns: 1fr; }
    }

    /* แถวอาการ */
    .sym-item{
      display:flex; align-items:center; gap:12px;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);
      border-radius:14px; padding:16px 18px;
    }

    /* สไตล์เช็กบ็อกซ์สี่เหลี่ยม */
    .sym-item input[type="checkbox"]{
      appearance:none; -webkit-appearance:none;
      width:20px; height:20px; border-radius:6px;
      border:2px solid rgba(255,255,255,.35);
      display:grid; place-items:center; cursor:pointer;
      background: transparent; transition: all .15s ease;
    }
    .sym-item input[type="checkbox"]::before{
      content:""; width:12px; height:12px; border-radius:3px;
      transform:scale(0); transition: transform .12s ease;
      background:#60a5fa;  /* ฟ้า */
      box-shadow: 0 0 0 2px rgba(96,165,250,.35) inset;
    }
    .sym-item input[type="checkbox"]:checked{
      border-color:#60a5fa; background:rgba(96,165,250,.1);
    }
    .sym-item input[type="checkbox"]:checked::before{ transform:scale(1); }

    .actions{ display:flex; justify-content:center; margin-top:20px; }
    .btn{
      min-width:160px;
      padding:12px 18px; border-radius:14px; cursor:pointer;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg,#3b82f6,#2563eb);
      color:#fff; font-weight:700; letter-spacing:.2px;
      box-shadow: 0 8px 26px rgba(37,99,235,.35);
      transition: transform .08s ease, filter .2s ease, opacity .2s ease;
    }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn[disabled]{ opacity:.55; pointer-events:none; filter:grayscale(.2); }

    .warn{ text-align:center; color:#ffb4b4; margin-top:10px; min-height:22px; }
  </style>
</head>
<body>
  <main class="card">
    <h1 id="symptoms" class="title">อาการร่วม</h1>
    <p class="subtitle">เลือกอาการที่พบร่วมกัน (เลือกได้หลายข้อ)</p>
    <p id="msg" class="warn"></p>
    …



    <p id="msg" class="warn"></p>

    <form id="symForm">
      <div class="grid">
        <!-- 15 อาการตามที่ขอ -->
        <label class="sym-item"><input type="checkbox" name="sym" value="คัดจมูก"> คัดจมูก</label>
        <label class="sym-item"><input type="checkbox" name="sym" value="น้ำมูกไหล"> น้ำมูกไหล</label>

        <label class="sym-item"><input type="checkbox" name="sym" value="เจ็บคอ"> เจ็บคอ</label>
        <label class="sym-item"><input type="checkbox" name="sym" value="ไข้ต่ำ"> ไข้ต่ำ</label>

        <label class="sym-item"><input type="checkbox" name="sym" value="ไข้สูง"> ไข้สูง</label>
        <label class="sym-item"><input type="checkbox" name="sym" value="อ่อนเพลีย"> อ่อนเพลีย</label>

        <label class="sym-item"><input type="checkbox" name="sym" value="ปวดศีรษะ"> ปวดศีรษะ</label>
        <label class="sym-item"><input type="checkbox" name="sym" value="เจ็บหน้าอก"> เจ็บหน้าอก</label>

        <label class="sym-item"><input type="checkbox" name="sym" value="หายใจลำบาก"> หายใจลำบาก</label>
        <label class="sym-item"><input type="checkbox" name="sym" value="ปวดเมื่อยตามตัว"> ปวดเมื่อยตามตัว</label>

        <label class="sym-item"><input type="checkbox" name="sym" value="หายใจเร็ว"> หายใจเร็ว</label>
        <label class="sym-item"><input type="checkbox" name="sym" value="หายใจหอบเหนื่อย"> หายใจหอบเหนื่อย</label>

        <label class="sym-item"><input type="checkbox" name="sym" value="เบื่ออาหาร"> เบื่ออาหาร</label>
        <label class="sym-item"><input type="checkbox" name="sym" value="น้ำหนักลด"> น้ำหนักลด</label>

        <label class="sym-item"><input type="checkbox" name="sym" value="เหงื่อออกตอนกลางคืน"> เหงื่อออกตอนกลางคืน</label>
      </div>

      <div class="actions">
        <button id="doneBtn" type="button" class="btn" disabled>เสร็จสิ้น</button>
      </div>
    </form>
  </main>

  <script>
  (() => {
    // === ชี้ API จริงของคุณ (Render) ===
    const API_URL = "https://coughcode.onrender.com/predict";

    const form = document.getElementById('symForm');
    const btn  = document.getElementById('doneBtn');
    const msg  = document.getElementById('msg');

    // ให้ปุ่มกดได้เมื่อเลือกอย่างน้อย 1 ข้อ
    function update(){
      const any = [...form.querySelectorAll('input[name="sym"]:checked')].length > 0;
      btn.disabled = !any;
      msg.textContent = any ? '' : 'เลือกอาการอย่างน้อย 1 ข้อ';
    }
    form.addEventListener('change', update); update();

    // dataURL (จากหน้าอัดเสียง) -> Blob
    function dataURLtoBlob(dataURL){
      const [head, b64] = dataURL.split(',');
      const mime = (head.match(/:(.*?);/)||[])[1] || 'application/octet-stream';
      const bin = atob(b64); const u8 = new Uint8Array(bin.length);
      for (let i=0;i<bin.length;i++) u8[i] = bin.charCodeAt(i);
      return new Blob([u8], {type:mime});
    }

    // Fallback คำนวณคะแนนจากอาการ ถ้าเรียก API ไม่สำเร็จ
    function fallbackFromSymptoms(sym){
      // ตัวอย่างสมมติ: ไข้หวัด / หลอดลมอักเสบ / ปอดอักเสบ
      let score = { "ไข้หวัด":0.40, "หลอดลมอักเสบ":0.35, "ปอดอักเสบ":0.25 };
      const has = k => sym.includes(k);

      // ทางเดินหายใจส่วนบน → ไข้หวัด
      if (has("คัดจมูก")) score["ไข้หวัด"] += 0.06;
      if (has("น้ำมูกไหล")) score["ไข้หวัด"] += 0.06;
      if (has("เจ็บคอ")) score["ไข้หวัด"] += 0.05;

      // ไข้
      if (has("ไข้ต่ำ")) score["ไข้หวัด"] += 0.04;
      if (has("ไข้สูง")) { score["ปอดอักเสบ"] += 0.06; score["หลอดลมอักเสบ"] += 0.02; }

      // อ่อนเพลีย/ปวดเมื่อย/ปวดศีรษะ
      if (has("อ่อนเพลีย")) score["ไข้หวัด"] += 0.02;
      if (has("ปวดเมื่อยตามตัว")) score["ไข้หวัด"] += 0.02;
      if (has("ปวดศีรษะ")) score["ไข้หวัด"] += 0.02;

      // อาการทางล่าง/รุนแรง → ปอด/หลอดลม
      if (has("เจ็บหน้าอก")) score["ปอดอักเสบ"] += 0.06;
      if (has("หายใจลำบาก")) { score["ปอดอักเสบ"] += 0.08; score["หลอดลมอักเสบ"] += 0.03; }
      if (has("หายใจเร็ว")) score["ปอดอักเสบ"] += 0.05;
      if (has("หายใจหอบเหนื่อย")) { score["ปอดอักเสบ"] += 0.08; score["หลอดลมอักเสบ"] += 0.04; }

      // อาการเรื้อรังทั่วไป
      if (has("เบื่ออาหาร")) score["ปอดอักเสบ"] += 0.02;
      if (has("น้ำหนักลด")) score["ปอดอักเสบ"] += 0.03;
      if (has("เหงื่อออกตอนกลางคืน")) score["ปอดอักเสบ"] += 0.03;

      const sum = Object.values(score).reduce((a,b)=>a+b,0);
      Object.keys(score).forEach(k=>score[k]/=sum);
      return score;
    }

    // เมื่อกด "เสร็จสิ้น"
    btn.addEventListener('click', async ()=>{
      // ต้องมีเสียงจากหน้า record.html
      const dataURL = sessionStorage.getItem('audioDataURL');
      if(!dataURL){ alert('ไม่พบไฟล์เสียง กรุณาบันทึกใหม่'); location.href='./record.html'; return; }
      const audioBlob = dataURLtoBlob(dataURL);

      const symptoms = [...form.querySelectorAll('input[name="sym"]:checked')].map(el=>el.value);
      sessionStorage.setItem('symptoms', JSON.stringify(symptoms));

      btn.disabled = true; btn.textContent = 'กำลังส่งข้อมูล...';
      const fd = new FormData();
      fd.append('file', audioBlob, 'recording.webm');
      fd.append('symptoms', JSON.stringify(symptoms));

      try{
        const r = await fetch(API_URL, { method:'POST', body: fd });
        if(!r.ok) throw new Error(await r.text());
        const json = await r.json();
        sessionStorage.setItem('diagnosis', JSON.stringify(json));
        sessionStorage.removeItem('diag_fallback');
        location.href = './result.html';
      }catch(e){
        const fb = { conditions: fallbackFromSymptoms(symptoms), note:'fallback' };
        sessionStorage.setItem('diagnosis', JSON.stringify(fb));
        sessionStorage.setItem('diag_fallback','1');
        location.href = './result.html';
      }
    });
  })();
  </script>
  <script>
(function(){
  const nav = document.querySelector('header.navbar') || document.querySelector('header');
  if(!nav) return;

  function setNavH(){
    const h = Math.ceil(nav.getBoundingClientRect().height);
    document.documentElement.style.setProperty('--nav-h', h + 'px');
  }
  setNavH();
  window.addEventListener('resize', setNavH);
  window.addEventListener('load', setNavH);
})();
</script>
</body>
</html>

</body>
</html>
